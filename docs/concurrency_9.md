# 코틀린의 동시성 내부

### 연속체 전달 스타일

- CPS : Continuation Passing Style
- 호출되는 함수에 연속체를 보내는 것을 전제로 하고 있어, 함수가 완료되는 대로 연속체를 호출할 것
- 연속체를 Callback으로 생각
- 일시 중단 연산이 다른 일시 중단 연산을 호출할 때마다 완료 또는 오류가 생겼을때 호출해야 하는 연속체를 전달
- 모든 일시 중단 연산은 연속체를 보내고 받도록 반환하는데, 이러한 대부분의 복잡한 작업은 컴파일러가 수행
- 일시 중단 함수의 실제 시크기니처가 정한 것과 같지 않음
- 일시 중단 연산은 상태 머신으로 변환되는데, 상태를 저장하고 복구하며 한 번에 코드의 한 부분을 실행
- 재개할 때마다 중단된 위치에서 상태를 복구하고 실행을 지속
- CPS와 상태 머신이 결합하면 컴파일러는 다른 연산이 완료되기를 기다리는 동안 일시 중단될 수 있는 연산을 생성

### 연속체

- 일시 중단 연산의 빌딩 블록
- Continuation interface
- 확장된 콜백에 가까우며, 호출되는 컨텍스트에 대한 정보도 퓨ㅗ함
- 각 연속체가 특정 스레드 혹은 스레프 풀에서 실행되거나 예외처리와 같은 다른 구성으로 실행되는 것을 허용하기 때문에 설계과정에서 매우 중요

### Suspend 한정자

- 동시성을 지원하기 위해 가능한 언어 변화를 작게 가져가기 위함
- 코루틴 및 동시성의 지원에 따른 영향은 컴파일러, 표준 라이브러리, 코루틴 라이브러리에서 취하도록
- 주어진 범위의 코드가 연속체를 사용해 동작하도록 컴파일러에게 지시
- 일시 중단 연산이 컴파일될 때마다 바이트코드가 하나의 커다란 연속체가 됨

### 상태 머신

- 일시 중단 함수가 상태 머신으로 변환될 것
- 일시 중단 함수가 현재의 상태를 기초로 해서 매번 재개되는 다른 코드 부분을 실행해 연속체로서 동작할 수 있다는 것

### 연속체

- 동일한 함수에서 간단히 어떤 호출을 콜백으로 리다이렉트하는 것

### 일시 중단 연산의 결과 반환

- 결과를 보내는 콜백으로서 전달받게 되는 첫번째 연속체를 사용

### 컨텍스트 전환

- 코루틴은 처음 시작한 컨텍스트가 아닌 다른 컨텍스트에서 다시 시작할 수 있다는 한가지 특징 있음
- CoroutineContext는 사용할 스레드와 스레드 풀에 대한것 뿐만 아니라 예외 처리와 같은 또 다른 중요한 구성을 포함
- Continuation 인터페이스는 CoroutineConext가 연속체 내부에 저장돼야 한다는 것을 정의
- 실행하는 도중에 연속체를 시작하거나 재개할 때 컨텍스트 사용이 가능하도록 보장

### 스레드 전환

- ContinuationIntercepter
  - CoroutineContext는 고유한 키와 함께 저장되는 서로 다른 coroutineContext.Element를 가지는 맵처럼 동작
  - 키와는 별개로 연속체를 취하고 다른 연속체를 반환하는 함수만 정의
  - ContinuaptionIntercepter의 구현은 수신된 연속체를 올바른 스레드가 사용되도록 보장하기 위해 다른 연속체로 랩핑하는 것
- CoroutineDispatcher
  - CommonPool, Unconfined 및 DefaultDispatcher와 같이 제공된 모든 디스패처의 구현을 위해 사용되는 ContinuationIntercepter의 추상 구현체
 
    
