# 스레드 한정, 액터 그리고 뮤텍스

### 원자성 위반

- 동시성 오류 유형
- 정확한 동기화 없이 객체의 상태를 동시에 수정할 때 발생
- 사로 다른 스레드에 있는 여러 코루틴이 객체의 상태를 수정했기 때문에 일부 수정 사항이 유실
- 식별하거나 재연하기 어려움

### 원자성이란

- 소프트웨어 실행의 관점에서, 연산이 단일하고 분할할 수 없을 때를 **원자적**이라고 함

### 동시성 애플리케이션에서의 원자성 위반

- 공유 상태를 수정하는 코드 블록이 다른 스레드의 변경 시도와 겹치면서 발생
- 하나 또는 그 이상의 공유 상태에 대한 변경사항이 덮어 씌워져 유실될 수 있음
- 두 개의 스레드가 같은 값을 읽지만 읽기와 스기가 중복돼 증가분 중 하나는 유실

### 코드 블록을 원자적으로

- 블록 안에서 발생하는 어던 메모리 액세스도 동시에 실행되지 않도록 해야 함

상태가 여러 스레드 간에 공유될 때만 문제가 발생할 수 있다는 점을 알고, 이러한 일이 일어나지 않도록 해야함

### 스레드 한정

- 공유 상태에 접근하는 모든 코루틴을 단일 스레드에서 실행되도록 한정하는 것
- 상태가 더 이상 스레드 간에 공유되지 않으며 하나의 스레드만 상태를 수정
- 모든 코루틴이 같은 스레드에서 상태를 수정해야 애플리케이션의 성능에 부정적인 영향을 미치지 않는다는 점을 알고 있을 때 한해서는 유용

### 액터

- 상태 액세스를 단일 스레드로 한정하고 다른 스레드가 채널로 상태 수정을 요청
- 값을 안전하게 업데이트할 수 있을 뿐만 아니라 이를 위한 강력한 커뮤니케이션 메커니즘을 가짐
- 채널이 전체 코루틴을 원자적으로 유지하면서, 더 높은 유연성을 허용한다는 점이 가장 큰 장점
- 특정 스레드에 한정된 코루틴이기 때문에 모든 수정은 원자적이므로 값이 항상 정확
- 통신하려는 액터의 인스턴스가 있는 한, 여러 곳에서도 호출 가능
- 송신 채널

### 버퍼드 액터

- 버퍼링 가능
- buffered = actor<*>(capacity = 10)

### CoroutineContext를 갖는 액터

- 액터 생성할 때 가질 수 있음

### CoroutineStart

- 필요에 따라 동작을 변경 가능

### 상호배제

- 한 번에 하나의 코루틴만 코드 블록을 실행할 수 있도록 하는 동기화 메커니즘

### 코틀린 뮤텍스

- 블록되지 않음
- 실행 대기 중인 코루틴은 잠금을 획득하고 코드 블록을 실행할 수 있을 때까지 일시 중단
- 코루틴은 일시 중단되지만 일시 중단 함수를 사용하지 않고 뮤텍스를 잠글 수 있음
- withLock()

### 휘발성 변수

- 일부 시나리오세서 스레드 간에 정보를 공유해야할 때 간단한 솔루션이 될 수 있음

### 스레드 캐시

- 항상 변수의 실제 값과 동기화되지는 않는다.
- 캐시가 업데이트될 떄까지 다른 스레이드에서 볼 수 없음

### @Volatile

- 변수의 변경사항을 다른 스레드에 즉시 표기
- 다른 스레드에서 값이 변경되자마자 변경사항에 대한 가시성을 확보
- BUT, 동기화 부족으로 인해 데이터 변경 내용이 유실될 수 있음


### 정리

- 스레드의 캐시와 메모리 액세스의 원자성으로 인해 다른 스레드에서 수행한 수정 사항이 유실될 수 있음
- 상태의 일관성을 해치는 원인
- 하나의 스레드만 상태와 상호 작용하도록 보장해서 쓰기가 아닌 읽기 전용으로만 공유할 수 있게 함
- 코드 블록을 원자적으로 만들기 위해서 잠금을 사용해 코드 블록을 실행하려는 모든 스레드의 동기화를 강제하는 것
- CoroutineContext를 하나의 스레드로 된 디스패처와 함께 사용해 코루틴의 실행을 단일 스레드에서 실행되도록 강제 -> 스레드 한정
- 액터를 단일 스레드로 한정해 메시지를 기반으로 하는, 보다 강력한 동기화 메커니즘을 구축
- 액터가 스레드 풀에서 실행하도록 액터가 사용할 CoroutineContext를 지정할 수 있음
- JVM은 스레드의 캐시에 저장되지 않는 변수인 휘발성 변수를 제공
- 수정될 때 새 값은 이전 값에 의존하지 않으며 휘발성 변수의 상태는 다른 속성에의존하지 않거나 영향을 미치지 않는 경우
- 원자적 변수는 단순한 경우에 유용하지만, 공유되는 상태가 하나 이상의 여러 변수인 경우 확장하기가 어려움
