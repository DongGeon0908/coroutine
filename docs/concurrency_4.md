# 일시 중단 함수와 코루틴 컨텍스트

### 일시 중단 함수

- 코루틴 빌더를 호출할 때 전달하는 코드는 일시 중단 람다
- 시그니처에 suspend 제어자만 추가하면 일시 중단 함수가 만들어짐
- 일시 중단 함수는 다른 일시 중단 함수를 직접 호출 가능
- 일시 중단 연산은 다른 일시 중단 연산에서만 호출 가능
- 비 일시 중단 코드에서 함수를 호출하려면 코루틴 빌더로 감싸야만 가능

### 잡 구현을 반환하는 함수의 단점

> 코루틴이 실행되는 동안에 일시 중단을 위해서 join()이나 await()을 사용하는 코드가 필요함

### 일시 중단 함수의 장점

- 유연함 : 인터페이스의 상세 구현 내용에 노출되지 않기 때문에, 다른 퓨처 라이브러리 구현에 사용 가능
- 간단함 : 명시적으로 await을 호출할 필요 없음

### 비동기 함수 대신, 일시 중단 함수 사용 가이드라인

- 구현에 job이 엮이는 것을 지양
- 인터페이스를 정의할 때는 항상 일시 중단 함수 사용
- 추상 함수를 사용할 때도 항상 일시 중단 함수 사용
- 비동기함수는 private 혹은 internal 함수로 구현

### 코루틴 컨텍스트

- 코루틴은 항상 컨텍스트 안에서 실행
- 컨텍스트는 코루틴이 어떻게 실행되고 동작해야 하는지를 정의할 수 있게 해주는 요소들의 그룹

### 디스패처

- 코루틴이 실행될 스레드를 결정
- 시작될 곳과 중단 후 재개될 곳을 모두 포함

### CommonPool

- CPU 바운드 작업을 위해서 프레임워크에 의해 자동으로 생성되는 스레드 풀
- 스레드 풀의 최대 크기는 시시트ㅔㅁ의 코어 수에서 1을 뺀 값

### 기본 디스패처

- DefaultDispatcher is Dispatchers.Default

### Unconfined

- 첫 번째 중단 지점에 도달할 때까지 현재 스레드에 있는 코루틴을 실행
- 코루틴은 일시 중지된 후에, 일시 중단 연산에서 사용된 기존 스레드에서 다시 시작

### 단일 스레드 컨텍스트

- 항상 코루틴이 특정 스레드 안에서 실행된다는 것을 보장
- newSingleThreadContext()

### 스레드 풀

- 스레드 풀을 갖고 있으며, 해당 풀에서 가용한 스레드에서 코루틴을 시작하고 재개
- 런타임이 가용한 스레드를 정하고 부하 분산을 위한 방법도 정하기 대문에 바로할 작업은 없음

### 예외처리

- 예측이 어려운 예외에 대한 동작을 정의
- CoroutineExceptionHandler

### Non-cancellable

- 코루틴의 실행이 취소되면 코루틴 내부에 CancellationException 유형의 예외가 발생하고 코루틴 종료
- try-finally 블록을 사용해 리소스를 닫는 클리닝 작업을 수행하거나 로깅 수행 가능
- 취소 중인 코루틴은 일시 중단될 수 없도록 설계
- 코루틴이 취소하는 동안 일시 중지가 필요한 경우 NonCancellabe 컨텍스트 사용
- 코루틴의 취소 여부와 관계없이 withContext()에 전달된 일시 중단 람다가 일시 중단될 수 있도록 보장

### 컨텍스트에 대한 추가 정보

- 컨텍스트 결합 가능
- 물론, 분리도 가능

### withContext()

- 코드 블록에 대한 컨텍스트를 변경 가능
- 코드 블록 실행을 위해 주어진 컨텍스트를 사용할 일시 중단 함수
- 다른 스레드에서 작업을 실행해야 할 필요가 있다면 계속 진행하기 전에 해당 작업이 끝날 때까지 항상 기다리게 됨
- 프로세스에 잡을 포함시키지 않고도 다른 컨텍스트로 전환 
